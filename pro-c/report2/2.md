# 第2回レポート課題

以下の課題についてレポートを作成しPDFをCLEから提出せよ。また、ソースコードをreplitのプロジェクトreport2からsubmitせよ。今回は機能の一部として実行時にリダイレクトでファイルを入力として与えることができるプログラムを作成するため、replit上で実行する際はRunを押すとエラーになる。Shellタブから、コマンドでコンパイルし実行すること。なお、[補足資料](2-support.md)を用意しているので、必ず目を通すこと。

## 課題 サブセット版のシェルを作成せよ。

シェル（コマンドインタプリタ）は UNIX ユーザにとって最も重要なプログラムである。 UNIX には、sh, csh, tcsh, bash など様々な種類のシェルが存在し、中にはファイル名の補完やヒストリなどの便利な機能を有したシェルもある。このようなシェルのサブセット版として以下の機能を有するシェルをC言語を用いて作成せよ。

-   実装するコマンドとして書かれているコマンド（cd,history 等）を実行する際に外部コマンドを直接使うのは課題を満たしていないこととする。
-   例えば、サブセット版のシェルでcdを実行すると、元のシェルでカレントディレクトリが変わっている場合は外部のcdコマンドを呼び出しているため、仕様を満たしていないことになる。

###  外部コマンドの実行機能

コマンドとして指定した別のプログラム（ls, firefox など）を実行できるようにする。

###  ディレクトリの管理機能

#### **cdコマンド**

cd (Change Directory) コマンドを作成し、カレントディレクトリを変更できるようにする。

- 仕様: ディレクトリ名が指定された場合は、そのディレクトリへカレントディレクトリを移動する。ディレクトリ名が指定されなかった場合は、環境変数 HOME に指定されたディレクトリへカレントディレクトリを移動する。ディレクトリの指定は絶対パス、相対パスのどちらでも可能なようにする。
```
cd [ディレクトリ名]
```

#### **pushdコマンド**

pushd (Push Directory) コマンドを作成し、ディレクトリスタックへカレントディレクトリを保存できるようにする。

- 仕様: ディレクトリスタックへカレントディレクトリを保存する。
```bash
pushd
```

#### **dirsコマンド**

dirs (Directory Stack) コマンドを作成し、現在のディレクトリスタックを表示できるようにする。


- 仕様: 現在のディレクトリスタックを、スタックの上（最初に取り出される方）から順に表示する。
```
dirs
```

#### **popdコマンド**

popd (Pop Directory) コマンドを作成し、現在のディレクトリスタックの1番上のディレクトリをカレントディレクトリに設定する。

- 仕様: 現在のディレクトリスタックの1番上のディレクトリをカレントディレクトリに設定する。取り出したディレクトリはスタックから削除する。
```
popd
```

###  ヒストリ機能

#### **historyコマンド**

history コマンドによってこれまでに実行したコマンドを、実行した順番とともに表示できるようにする。

- 仕様: シェルを起動してから実行したコマンドをヒストリとして実行した順番とともに保存しておき、それを古いもの（番号の小さいもの）から順に表示する。なお、ヒストリとして保存するコマンドの数は 32 個とし、コマンドとともに保持する順番はシェル起動時を基準とした順番とする。
```
history
```

#### **!!コマンド**

!!コマンドによって1つ前のコマンドを再度実行できるようにする。

- 仕様: シェルを起動してから実行したコマンドをヒストリとして実行した順番とともに保存しておき、 1つ前に実行したコマンドを再度実行できるようにする。再度実行したコマンドも新たにヒストリに追加する。

```
!!
```

#### **!stringコマンド**

ヒストリに保存されたコマンドの内、stringで始まる最新のコマンドを実行する。stringsは1文字以上の任意の文字列である。

- 仕様: シェルを起動してから実行したコマンドをヒストリとして実行した順番とともに保存しておき、 stringで始まる最新のコマンドを再度実行できるようにする。stringで始まるコマンドがない場合には、エラーメッセージを表示する。ただし、stringで始まるコマンドがあるかないかの判定は、historyコマンドで保存している履歴の範囲内で判断してよい。また、再度実行したコマンドも新たにヒストリに追加する。

```
!string
```

例えば、以下のコマンドを実行していたとする。

```bash
ls -a
pushd
ls -l
cat test.txt
popd
ls
```

このときに、

```
!l
```

を実行すると、`ls` が実行され、

```
!p
```

を実行すると、`popd` が実行され、

```
!pu
```

を実行すると、`pushd` が実行される。

####  ワイルド・カード機能

記号 "*" によってファイル名を補完する機能を実現する。

- 仕様: コマンドにある "*" をカレントディレクトリにある全てのファイル名に置換する。例えば、カレントディレクトリにfile1.txt, file2.txt, file3.txtという三つのファイルがある場合に、
```bash
cp * ../dir/
```
を
```bash
cp file1.txt file2.txt file3.txt ../dir/
```

というように置換する。

補完するパターンは以下に挙げるものとする。

- `*`: カレントディレクトリにある全てのファイル名（ディレクトリは含めても含めなくても良い）

###  プロンプトの変更機能

prompt コマンドによってプロンプトを変更できるようにする。

- 仕様: strings によって指定された文字列にプロンプトを変更する。文字列が指定されなかった場合は、デフォルトの文字列 "Command : "に変更する。

```bash
prompt [strings]
```

###  スクリプト機能

1行に1つのコマンドを記述したテキストファイルを標準入力から読み込み、実行する。

- 仕様: 作成したシェルmyshが、`script_file`に記述されたコマンドを実行する。 exitがなくても正常終了することが必要である。通常のシェルでは、標準入力が端末でない場合にはプロンプトを出力しないが、本課題では端末の場合と同様にプロンプトを出力しても良い。

mysh < `script_file`

なお、mysh は、作成するシェル上のコマンド名ではなく、作成するシェルのファイル名である。すなわち、スクリプト機能はシェル上のコマンドとして実装するのではなく、作成するシェルが標準入力から1行に1つのコマンドを記述したテキストファイルを読み込む機能として実装すること。

###  エイリアス機能

#### alias

alias コマンドによってコマンドの別名を設定できるようにする。

- 仕様: command1 が入力されたときに、command2に置き換えて実行する。

```bash
alias [command1 command2]
```

例えば、
```bash
alias sl ls
```
とすると、それ以降
```bash
sl
```
と入力しても、
```bash
ls
```
が実行される。また、引数なしで aliasコマンドを実行した場合には、現在登録されている alias の一覧を表示すること。

```bash
alias
sl  ls
cls clear
md  mkdir
```

#### unalias

unalias コマンドによって、別名設定された command1 を解除する。

```bash
unalias command1
```

###  自分で考えた機能（1つ）

上述の機能以外に、他のシェルなどを参考にして自分で考えた機能を1つ追加する。

ただし、上記で指定した機能の亜種は認めない。例えば、ヒストリーを逆順で表示する「rhistoryコマンド」を考えたとする。これは、自分で考えた「機能」ではなく、単なるhistoryコマンドの表示方法である。機能発案の創造性を問う課題ではないので、有用な機能である必要はなく、また、既存のシェルに実装されている機能を禁止するものでもない。課題で指定されたコマンドの亜種ではなく、自身で機能を考えることが重要である。また、下記に示す拡張課題を作成したとしても本課題を満たさないとする。

---

なお、余力のある者は以下の機能を実現せよ。

###  ヒストリ機能の拡張

#### !n

　!n （n は数字）コマンドによって n で指定した順番に実行したコマンドを再度実行できるようにする。

#### !-n

　!-n （n は数字）コマンドによって n 個前のコマンドを再度実行できるようにする。

###  ワイルドカード機能の拡張

#### strings*

　カレントディレクトリにあるファイル名の前の部分が strings にマッチする全てのファイル名を補完する。stringsは、1文字以上の任意の文字列である。

#### *strings

　カレントディレクトリにあるファイル名の後ろの部分が strings にマッチする全てのファイル名を補完する。stringsは、1文字以上の任意の文字列である。

###  その他自分で考えた機能

-   仕様や動作に関してはレポート内に記載すること．

## 提出物

レポートは [レポート作成上の注意](writing.md) に従い LaTeX で作成し、PDF形式のファイルとして提出せよ。また、レポートには以下の内容を忘れずに含めること。

1.  課題内容
2.  プログラム全体の説明
    1.  仕様
    2.  処理の流れ（処理概要）
    3.  実装方法
3.  外部コマンドの実行機能
    1.  仕様
    2.  処理の流れ（処理概要）
    3.  実装方法
    4.  テスト（テスト方法とテスト結果を両方書くこと）
4.  ディレクトリの管理機能
    1.  仕様
    2.  処理の流れ（処理概要）
    3.  実装方法
    4.  テスト（テスト方法とテスト結果を両方書くこと）
5.  ヒストリー機能
    1.  仕様
    2.  処理の流れ（処理概要）
    3.  実装方法
    4.  テスト（テスト方法とテスト結果を両方書くこと）
6.  以下同様に、ワイルドカード機能、プロンプト機能など、それぞれの機能に対して、仕様・処理の流れ・実装方法・テスト結果(**特に自分で考えた機能については、コマンド名、どのような機能であるか、どのようにして実現しているか、などを詳しく書くこと。**)
7.  工夫点
8.  考察
9.  感想
10.  謝辞（必要に応じて）
11.  参考文献（必要に応じて）
12.  プログラムリスト(付録として添付)

レポート2の内容は[report2.pdf](/proc/dist/report2.pdf)を参考にすること。

#### レポートの提出

作成したレポートファイルを [CLE](https://cle.koan.osaka-u.ac.jp/) に提出せよ．ファイル名は特に指定しない．．ソースコードはreplitのプロジェクトreport2からsubmitすること．

#### 提出期限

- 受講生(A) : 2022年8月2日(月)23:59
- 受講生(B) : 2022年6月28日(火)23:59

### 補足事項

自分で考えた機能を2つ以上追加した場合には、追加分の各機能について、その機能の便利さや複雑さなどを考慮して1～5点の範囲でボーナス得点を与えることとする。ボーナス得点は満点を超えても加算するので、これまでのレポート課題での失点を挽回可能である。

### ヒント

-   別のプログラムを実行する機能のみを有する簡易版シェルに関する[補足資料](2-support.md) を用意しているので、それを参考にすること。
-   カレントディレクトリの取得は getcwd 関数により実現できる。オンラインマニュアルを参照し、関連項目として出てくる関数などを用いてディレクトリ操作を実現せよ。
-   ホームディレクトリの取得は getenv 関数により実現できる。詳しくは、オンラインマニュアルを参照せよ。
-   スクリプト機能については、他のコマンドと違って、シェル上での新しいコマンドとして実装する必要はなく、基本的にEOFを検出して終了する機能を実装すれば良い。
-   リストや配列を使用するに当たってメモリを動的に確保した場合には、プログラム終了時に必ずメモリ解放を行うようにすること。メモリ解放忘れがある場合には減点対象とするので注意すること。
-   スタックは単方向リストを使えば実現できる。以下の図を参考にせよ。

